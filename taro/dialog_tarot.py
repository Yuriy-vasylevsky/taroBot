
import re
import random
import asyncio
import io
from typing import List, Dict
from modules.menu import build_main_menu
from modules.menu import menu
from aiogram import Router, types, F
from aiogram.fsm.state import State, StatesGroup
from aiogram.fsm.context import FSMContext
from aiogram.types import ReplyKeyboardMarkup, KeyboardButton

from openai import AsyncOpenAI
from cards_data import TAROT_CARDS
from PIL import Image
import config

dialog_router = Router()

# GPT client init
client = AsyncOpenAI(api_key=config.OPENAI_API_KEY)


# ================= MESSAGE HISTORY PER USER ===================

user_histories: Dict[int, List[Dict[str, str]]] = {}


def get_history(user_id: int) -> List[Dict[str, str]]:
    if user_id not in user_histories:
        user_histories[user_id] = []
    return user_histories[user_id]


def add_message(user_id: int, role: str, content: str):
    hist = get_history(user_id)
    hist.append({"role": role, "content": content})
    # –æ–±–º–µ–∂—É—î–º–æ —ñ—Å—Ç–æ—Ä—ñ—é
    if len(hist) > 30:
        user_histories[user_id] = hist[-30:]


# =================== CARD DRAWING ===================


def draw_cards(amount: int):
    names = list(TAROT_CARDS.keys())
    amount = max(1, min(amount, len(names), 10))  # –Ω–µ –±—ñ–ª—å—à–µ 10 –∫–∞—Ä—Ç
    chosen = random.sample(names, amount)
    result = []
    for name in chosen:
        upright = random.choice([True, False])
        ua = TAROT_CARDS[name]["ua_name"]
        img_path = TAROT_CARDS[name]["image"]
        result.append(
            {
                "code": name,
                "ua": ua,
                "upright": upright,
                "image": img_path,
            }
        )
    return result


def load_img(path: str, upright: bool):
    img = Image.open(path)
    if not upright:
        img = img.rotate(180, expand=True)

    buf = io.BytesIO()
    img.save(buf, format="JPEG")
    buf.seek(0)
    return buf


# ================== GPT SYSTEM PROMPTS ==================

SYSTEM_PROMPT_CORE = """
–¢–∏ ‚Äî —Ç–µ–ø–ª–∏–π, —ñ–Ω—Ç—É—ó—Ç–∏–≤–Ω–∏–π —Ç–∞—Ä–æ–ª–æ–≥-–Ω–∞—Å—Ç–∞–≤–Ω–∏–∫.
–ì–æ–≤–æ—Ä–∏—à –º'—è–∫–æ, –ø–æ-–ª—é–¥—Å—å–∫–∏, –±–µ–∑ –ø–∞—Ñ–æ—Å—É, –∞–ª–µ –≥–ª–∏–±–æ–∫–æ –π –ø—ñ–¥—Ç—Ä–∏–º—É—é—á–µ.

–ì–û–õ–û–í–ù–Ü –ü–†–ê–í–ò–õ–ê:

1) –¢–∏ –ù–Ü–ö–û–õ–ò –Ω–µ –≤–∏–≥–∞–¥—É—î—à –∫–∞—Ä—Ç–∏ —Å–∞–º.
   –¢–∏ –Ω–µ –º–æ–∂–µ—à –Ω–∞–∑–∏–≤–∞—Ç–∏ –∫–∞—Ä—Ç—É, –æ–ø–∏—Å—É–≤–∞—Ç–∏ —ó—ó —á–∏ –∫–∞–∑–∞—Ç–∏ ¬´—è –±–∞—á—É –∫–∞—Ä—Ç—É/–≤–∏—Ç—è–≥–Ω—É–≤ –∫–∞—Ä—Ç—É¬ª,
   –¥–æ–∫–∏ –±–æ—Ç –Ω–µ –Ω–∞–¥—ñ—à–ª–µ —Ç–æ–±—ñ —Ç–µ–∫—Å—Ç –Ω–∞ –∫—à—Ç–∞–ª—Ç:
   ¬´–í–∏—Ç—è–≥–Ω—É—Ç—ñ –∫–∞—Ä—Ç–∏:
    ...¬ª.

2) –¢–∏ –º–æ–∂–µ—à –ü–†–û–ü–û–ù–£–í–ê–¢–ò –∑—Ä–æ–±–∏—Ç–∏ —Ä–æ–∑–∫–ª–∞–¥ –∞–±–æ –≤–∏—Ç—è–≥–Ω—É—Ç–∏ –∫–∞—Ä—Ç–∏:
   - ¬´–Ø –±–∏ –∑–∞–ø—Ä–æ–ø–æ–Ω—É–≤–∞–≤ –æ–¥–Ω—É –∫–∞—Ä—Ç—É —è–∫ –ø—ñ–¥–∫–∞–∑–∫—É –Ω–∞ –¥–µ–Ω—å¬ª.
   - ¬´–î–ª—è —Ü—ñ—î—ó —Ç–µ–º–∏ –¥–æ–±—Ä–µ –ø—ñ–¥—ñ–π–¥–µ —Ä–æ–∑–∫–ª–∞–¥ –Ω–∞ —Ç—Ä–∏ –∫–∞—Ä—Ç–∏¬ª.
   - ¬´–¢—É—Ç –≤–∞—Ä—Ç–æ –≤–∑—è—Ç–∏ –ø'—è—Ç—å –∫–∞—Ä—Ç, —â–æ–± –ø–æ–±–∞—á–∏—Ç–∏ —Å–∏—Ç—É–∞—Ü—ñ—é –≥–ª–∏–±—à–µ¬ª.
   - ¬´–î–ª—è —Å–µ—Ä–π–æ–∑–Ω–æ–≥–æ –ø–∏—Ç–∞–Ω–Ω—è –º–æ–∂–Ω–∞ –∑—Ä–æ–±–∏—Ç–∏ –ö–µ–ª—å—Ç—Å—å–∫–∏–π —Ö—Ä–µ—Å—Ç –Ω–∞ 10 –∫–∞—Ä—Ç¬ª.

   –ì–æ–ª–æ–≤–Ω–µ ‚Äî —Ç–∏ —Ñ–æ—Ä–º—É–ª—é—î—à —Ü–µ –ª—é–¥—Å—å–∫–æ—é –º–æ–≤–æ—é,
   –∑ —á—ñ—Ç–∫–æ –∑–∞–∑–Ω–∞—á–µ–Ω–æ—é –∫—ñ–ª—å–∫—ñ—Å—Ç—é –∫–∞—Ä—Ç (1, 3, 4, 5 –∞–±–æ 10).

3) –ö–æ–ª–∏ –±–æ—Ç –Ω–∞–¥—Å–∏–ª–∞—î —Ç–æ–±—ñ:
   ¬´–í–∏—Ç—è–≥–Ω—É—Ç—ñ –∫–∞—Ä—Ç–∏:
    ...¬ª
   ‚Äî —Ç–∏ —Ç–ª—É–º–∞—á–∏—à –°–¢–†–û–ì–û —Ü—ñ –∫–∞—Ä—Ç–∏.
   –ù–µ –¥–æ–¥–∞—î—à –Ω–æ–≤–∏—Ö –∫–∞—Ä—Ç —ñ –Ω–µ –∑–º—ñ–Ω—é—î—à —ó—Ö.

4) –¢–∏ –ù–ï –ø–∏—à–µ—à —Ñ—Ä–∞–∑: 
   - ¬´–î—è–∫—É—é –∑–∞ –≤–∏—Ç—è–≥–Ω—É—Ç—ñ –∫–∞—Ä—Ç–∏¬ª
   - ¬´–î—è–∫—É—é —â–æ –ø–æ–¥—ñ–ª–∏–≤—Å—è —Ü–∏–º–∏ –∫–∞—Ä—Ç–∞–º–∏¬ª
   - ¬´–°–∫–∞–∂–∏, –∫–æ–ª–∏ –≤–∏—Ç—è–≥–Ω–µ—à –∫–∞—Ä—Ç—É¬ª
   - ¬´–Ø –∑–∞—á–µ–∫–∞—é –Ω–∞ –∫–∞—Ä—Ç—É –≤—ñ–¥ —Ç–µ–±–µ¬ª
   - ¬´–ö–æ–ª–∏ –∫–∞—Ä—Ç–∞ –±—É–¥–µ –≤–∏—Ç—è–≥–Ω—É—Ç–∞, —è –ø—Ä–æ–¥–æ–≤–∂—É¬ª

   –£—Å–µ –≤—ñ–¥–±—É–≤–∞—î—Ç—å—Å—è —Ç–∞–∫, –Ω—ñ–±–∏ –º–∞–≥—ñ—è —Ç–∞ —Ä–æ–∑–∫–ª–∞–¥ –≤–∂–µ –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ –≤–∏–∫–æ–Ω—É—é—Ç—å—Å—è.
4.1) –Ω—ñ–∫–æ–ª–∏ –Ω–µ –¥—è–∫—É–π –∑–∞ –∫–∞—Ä—Ç–∏
5) –°—Ç–∏–ª—å:
   - –¢–∏ –¥–∏–≤–∏—à—Å—è –Ω–∞ –∑–∞–≥–∞–ª—å–Ω—É –∫–∞—Ä—Ç–∏–Ω—É —Ä–æ–∑–∫–ª–∞–¥—É, –ø–æ–∫–∞–∑—É—î—à –∑–≤'—è–∑–∫–∏ –º—ñ–∂ –∫–∞—Ä—Ç–∞–º–∏.
   - –ü–æ—è—Å–Ω—é—î—à –º'—è–∫–æ, —á–µ—Å–Ω–æ, –±–µ–∑ –∑–∞–ª—è–∫—É–≤–∞–Ω—å.
   - –ü–∞–º'—è—Ç–∞—î—à, —â–æ –¢–∞—Ä–æ ‚Äî –Ω–µ –≤–∏—Ä–æ–∫, –∞ –æ—Ä—ñ—î–Ω—Ç–∏—Ä.
   - –ö–æ–ª–∏ —Ç—Ä–µ–±–∞ –¥–∞—î—à —á—ñ—Ç–∫—É –≤—ñ–¥–ø–æ–≤—ñ–¥—å –Ω–∞ –ø–∏—Ç–∞–Ω–Ω—è –±–µ–∑ –≤–æ–¥–∏ –Ω–∞ –æ—Å–Ω–æ–≤—ñ –∫–∞—Ä—Ç

6) –ö–æ–ª–∏ —Ç–∏ –∫–∞–∂–µ—à —è–∫–∏–π —Ä–æ–∫–ª–∞–¥ —Ç–∞—Ä–æ —Ç–∏ –± –∑—Ä–æ–±–∏–≤ –Ω–∞ —Ç–µ —á–∏ —ñ–Ω—à–µ –ø–∏—Ç–∞–Ω–Ω—è –Ω—ñ–∫–æ–ª–∏ –Ω–µ –ø–∏—Ç–∞–π —á–∏ –ø—ñ–¥—Ö–æ–¥–∏—Ç—å –≤–∞–º —Ç–∞–∫–∏–π —Ç–∏–ø —Ä–æ–∑–∫–ª–∞–¥—É —Ç–∞—Ä–æ, –ø—Ä–æ—Å—Ç–æ —Ä–æ–±–∏ –π–æ–≥–æ

"""


SPREADS_KB_PROMPT = """
–£ —Ç–µ–±–µ —î –±–∞–∑–∞ –∑–Ω–∞–Ω—å –ø—Ä–æ –æ—Å–Ω–æ–≤–Ω—ñ —Ä–æ–∑–∫–ª–∞–¥–∏ –¢–∞—Ä–æ, –∞–¥–∞–ø—Ç–æ–≤–∞–Ω–∞ –ø—ñ–¥ –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü—ñ—ó –≤ —á–∞—Ç—ñ:

1) ¬´–ö–∞—Ä—Ç–∞ –¥–Ω—è¬ª ‚Äî 1 –∫–∞—Ä—Ç–∞.
   –ü—ñ–¥—Ö–æ–¥–∏—Ç—å –¥–ª—è –∑–∞–ø–∏—Ç—ñ–≤:
   - –ø–æ—Ä–∞–¥–∞ –Ω–∞ –¥–µ–Ω—å
   - ¬´—è–∫ –ø—Ä–æ–∂–∏—Ç–∏ —Ü–µ–π –¥–µ–Ω—å¬ª
   - –∑–∞–≥–∞–ª—å–Ω–∏–π –Ω–∞—Å—Ç—Ä—ñ–π –¥–Ω—è.
   –°—Ç—Ä—É–∫—Ç—É—Ä–∞: 1 –∫–∞—Ä—Ç–∞ ‚Äî –æ—Å–Ω–æ–≤–Ω–∞ –µ–Ω–µ—Ä–≥—ñ—è —Ç–∞ –ø—ñ–¥–∫–∞–∑–∫–∞.

2) ¬´–¢—Ä–∏ –∫–∞—Ä—Ç–∏¬ª ‚Äî 3 –∫–∞—Ä—Ç–∏.
   –î—É–∂–µ —É–Ω—ñ–≤–µ—Ä—Å–∞–ª—å–Ω–∏–π —Ä–æ–∑–∫–ª–∞–¥.
   –í–∞—Ä—ñ–∞–Ω—Ç–∏:
   - –ú–∏–Ω—É–ª–µ ‚Äî –¢–µ–ø–µ—Ä—ñ—à–Ω—î ‚Äî –ú–∞–π–±—É—Ç–Ω—î.
   - –©–æ –¥–æ–ø–æ–º–∞–≥–∞—î ‚Äî –©–æ –∑–∞–≤–∞–∂–∞—î ‚Äî –Ø–∫ –¥—ñ—è—Ç–∏.
   –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–π –¥–ª—è:
   - –∑–∞–≥–∞–ª—å–Ω–∏—Ö –∂–∏—Ç—Ç—î–≤–∏—Ö —Å–∏—Ç—É–∞—Ü—ñ–π,
   - —Ä–æ–∑–≤–∏—Ç–∫—É —Å—Ç–æ—Å—É–Ω–∫—ñ–≤,
   - —Ä–æ–±–æ—Ç–∏ —Ç–∞ –æ—Å–æ–±–∏—Å—Ç–∏—Ö —Ä—ñ—à–µ–Ω—å.

3) ¬´4 –∫–∞—Ä—Ç–∏ –¥–ª—è —Å—Ç–æ—Å—É–Ω–∫—ñ–≤¬ª ‚Äî 4 –∫–∞—Ä—Ç–∏.
   –ü–∏—Ç–∞–Ω–Ω—è –ø—Ä–æ –ª—é–±–æ–≤ —Ç–∞ –≤–∑–∞—î–º–∏–Ω–∏.
   –°—Ç—Ä—É–∫—Ç—É—Ä–∞:
   1 ‚Äî —è–∫ –≤–∏–≥–ª—è–¥–∞—é—Ç—å —Å—Ç–æ—Å—É–Ω–∫–∏ –≤ —Ü—ñ–ª–æ–º—É;
   2 ‚Äî —â–æ –≤–∏ –≤—ñ–¥—á—É–≤–∞—î—Ç–µ –æ–¥–∏–Ω –¥–æ –æ–¥–Ω–æ–≥–æ;
   3 ‚Äî —â–æ –∑–∞–≤–∞–∂–∞—î –∞–±–æ –Ω–∞–ø—Ä—É–∂—É—î;
   4 ‚Äî –º–æ–∂–ª–∏–≤–∏–π —Ä–æ–∑–≤–∏—Ç–æ–∫/—Ä–µ–∑—É–ª—å—Ç–∞—Ç.

4) ¬´5 –∫–∞—Ä—Ç ‚Äî –ø–æ–≥–ª–∏–±–ª–µ–Ω–∏–π —Ä–æ–∑–∫–ª–∞–¥ —Å–∏—Ç—É–∞—Ü—ñ—ó¬ª ‚Äî 5 –∫–∞—Ä—Ç.
   –ü—ñ–¥—ñ–π–¥–µ –¥–ª—è —Å–µ—Ä–π–æ–∑–Ω—ñ—à–∏—Ö —Ç–µ–º: –ø–µ—Ä–µ—ó–∑–¥, –≤–∞–∂–ª–∏–≤—ñ —Ä—ñ—à–µ–Ω–Ω—è, —Ä–æ–±–æ—Ç–∞, —à–ª—è—Ö —Ä–æ–∑–≤–∏—Ç–∫—É.
   –°—Ç—Ä—É–∫—Ç—É—Ä–∞:
   1 ‚Äî –ø–æ—Ç–æ—á–Ω–∞ —Å–∏—Ç—É–∞—Ü—ñ—è;
   2 ‚Äî —â–æ –¥–æ–ø–æ–º–∞–≥–∞—î / —Ä–µ—Å—É—Ä—Å;
   3 ‚Äî —â–æ –∑–∞–≤–∞–∂–∞—î / –≤–∏–∫–ª–∏–∫–∏;
   4 ‚Äî –ø—Ä–∏—Ö–æ–≤–∞–Ω—ñ —Ñ–∞–∫—Ç–æ—Ä–∏ / —Ç–µ, —á–æ–≥–æ –Ω–µ –≤–∏–¥–Ω–æ;
   5 ‚Äî –º–æ–∂–ª–∏–≤–∏–π –Ω–∞–ø—Ä—è–º–æ–∫ —Ä–æ–∑–≤–∏—Ç–∫—É / —Ä–µ–∑—É–ª—å—Ç–∞—Ç.

   –¢–∞–∫–æ–∂ 5 –∫–∞—Ä—Ç –º–æ–∂–Ω–∞ –∞–¥–∞–ø—Ç—É–≤–∞—Ç–∏ –ø—ñ–¥:
   - —Ä–æ–±–æ—Ç—É/–∫–∞—Ä'—î—Ä—É,
   - —Å—Ç–æ—Å—É–Ω–∫–∏,
   - –≤–Ω—É—Ç—Ä—ñ—à–Ω—ñ–π —Å—Ç–∞–Ω.

5) ¬´–ö–µ–ª—å—Ç—Å—å–∫–∏–π —Ö—Ä–µ—Å—Ç¬ª ‚Äî 10 –∫–∞—Ä—Ç.
   –ì–ª–∏–±–æ–∫–∏–π, –¥–µ—Ç–∞–ª—å–Ω–∏–π —Ä–æ–∑–∫–ª–∞–¥ –¥–ª—è –≤–∞–∂–ª–∏–≤–∏—Ö, –∫–æ–º–ø–ª–µ–∫—Å–Ω–∏—Ö –ø–∏—Ç–∞–Ω—å.
   –ü—Ä–∏–±–ª–∏–∑–Ω–∞ —Å—Ç—Ä—É–∫—Ç—É—Ä–∞:
   1 ‚Äî –ø–æ—Ç–æ—á–Ω–∞ —Å–∏—Ç—É–∞—Ü—ñ—è;
   2 ‚Äî –≥–æ–ª–æ–≤–Ω–∏–π –≤–∏–∫–ª–∏–∫ –∞–±–æ —Ç–µ, —â–æ –ø–µ—Ä–µ—Ö—Ä–µ—â—É—î —Å–∏—Ç—É–∞—Ü—ñ—é;
   3 ‚Äî –∫–æ—Ä—ñ–Ω—å –ø—Ä–æ–±–ª–µ–º–∏ / –≥–ª–∏–±–∏–Ω–Ω–∞ –æ—Å–Ω–æ–≤–∞;
   4 ‚Äî –º–∏–Ω—É–ª–µ, —â–æ –≤–ø–ª–∏–Ω—É–ª–æ;
   5 ‚Äî —Ç–µ, —â–æ –Ω–∞–¥ —Å–∏—Ç—É–∞—Ü—ñ—î—é / —Ç–µ–Ω–¥–µ–Ω—Ü—ñ—è;
   6 ‚Äî –Ω–∞–π–±–ª–∏–∂—á–µ –º–∞–π–±—É—Ç–Ω—î;
   7 ‚Äî —Ç–∏ –π —Ç–≤–æ—î —Å—Ç–∞–≤–ª–µ–Ω–Ω—è;
   8 ‚Äî –∑–æ–≤–Ω—ñ—à–Ω—ñ –æ–±—Å—Ç–∞–≤–∏–Ω–∏ / –≤–ø–ª–∏–≤–∏;
   9 ‚Äî –Ω–∞–¥—ñ—ó –π –ø–æ–±–æ—é–≤–∞–Ω–Ω—è;
   10 ‚Äî –ø—ñ–¥—Å—É–º–æ–∫ / –ø–æ—Ç–µ–Ω—Ü—ñ–π–Ω–∏–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç.

–Ø–∫ —Ü–µ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–≤–∞—Ç–∏:
- –°–ø–æ—á–∞—Ç–∫—É –µ–º–æ—Ü—ñ–π–Ω–æ –≤—ñ–¥–≥—É–∫–Ω–∏—Å—å –Ω–∞ –∑–∞–ø–∏—Ç –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞.
- –ü–æ—Ç—ñ–º –∑–∞–ø—Ä–æ–ø–æ–Ω—É–π —Ç–æ–π —Ä–æ–∑–∫–ª–∞–¥, —è–∫–∏–π –Ω–∞–π–∫—Ä–∞—â–µ –≤—ñ–¥–ø–æ–≤—ñ–¥–∞—î —Å–∏—Ç—É–∞—Ü—ñ—ó,
  —ñ —á—ñ—Ç–∫–æ —Å–∫–∞–∂–∏, –Ω–∞ —Å–∫—ñ–ª—å–∫–∏ –∫–∞—Ä—Ç —Ç–∏ –ø—Ä–æ–ø–æ–Ω—É—î—à —Ä–æ–∑–∫–ª–∞–¥:
  ¬´–Ø –±–∏ –∑–∞–ø—Ä–æ–ø–æ–Ω—É–≤–∞–≤ —Ä–æ–∑–∫–ª–∞–¥ –Ω–∞ —Ç—Ä–∏ –∫–∞—Ä—Ç–∏...¬ª
  ¬´–¢—É—Ç –ø–∞—Å—É—î —Ä–æ–∑–∫–ª–∞–¥ –Ω–∞ –ø'—è—Ç—å –∫–∞—Ä—Ç...¬ª
  ¬´–ú–æ–∂–µ–º–æ –∑—Ä–æ–±–∏—Ç–∏ –ö–µ–ª—å—Ç—Å—å–∫–∏–π —Ö—Ä–µ—Å—Ç –Ω–∞ –¥–µ—Å—è—Ç—å –∫–∞—Ä—Ç...¬ª
- –ü—ñ—Å–ª—è —Ç–æ–≥–æ —è–∫ –±–æ—Ç –≤–∏—Ç—è–≥–Ω–µ –∫–∞—Ä—Ç–∏ —ñ –Ω–∞–¥—ñ—à–ª–µ —Å–ø–∏—Å–æ–∫
  ¬´–í–∏—Ç—è–≥–Ω—É—Ç—ñ –∫–∞—Ä—Ç–∏: ...¬ª
  ‚Äî —Ç–ª—É–º–∞—á —ó—Ö —Ü—ñ–ª—ñ—Å–Ω–æ, —è–∫ –æ–¥–∏–Ω –∂–∏–≤–∏–π –º–∞–ª—é–Ω–æ–∫.
"""

SYSTEM_PROMPT = SYSTEM_PROMPT_CORE + "\n\n" + SPREADS_KB_PROMPT


# ================================================================


class TarotChatFSM(StatesGroup):
    chatting = State()


EXIT_TEXT = "‚¨ÖÔ∏è –ó–∞–≤–µ—Ä—à–∏—Ç–∏ –±–µ—Å—ñ–¥—É"


def dialog_kb():
    return ReplyKeyboardMarkup(
        resize_keyboard=True,
        keyboard=[[KeyboardButton(text=EXIT_TEXT)]],
    )



# def dialog_kb():
#     """–ü–æ–≤–µ—Ä—Ç–∞—î –∫–ª–∞–≤—ñ–∞—Ç—É—Ä—É –∑ –∫–Ω–æ–ø–∫–æ—é –≤–∏—Ö–æ–¥—É"""
#     return ReplyKeyboardMarkup(
#         resize_keyboard=True,
#         keyboard=[[KeyboardButton(text=EXIT_TEXT)]],
#     )

# # === –û–±—Ä–æ–±–Ω–∏–∫ –Ω–∞—Ç–∏—Å–∫–∞–Ω–Ω—è "üîô –í–∏—Ö—ñ–¥" ===
# @dialog_router.message(F.text == EXIT_TEXT)
# async def back_to_main_menu(message: types.Message):
#     kb = build_main_menu(message.from_user.id)
#     await message.answer("üîô –ü–æ–≤–µ—Ä—Ç–∞—é –≤ –º–µ–Ω—é.", reply_markup=kb)

# ================== HELPER: DETECT CARD REQUEST ===================


def _norm(text: str) -> str:
    # –ø—Ä–∏–≤–µ–¥–µ–º–æ –¥–æ –Ω–∏–∂–Ω—å–æ–≥–æ —Ç–∞ –∑–∞–º—ñ–Ω–∏–º–æ —Ä—ñ–∑–Ω—ñ –∞–ø–æ—Å—Ç—Ä–æ—Ñ–∏
    return text.lower().replace("‚Äô", "'").replace("‚Äò", "'")


def detect_card_request(reply: str) -> int | None:
    """
    –ü–æ–≤–µ—Ä—Ç–∞—î –∫—ñ–ª—å–∫—ñ—Å—Ç—å –∫–∞—Ä—Ç (1/3/4/5/10), —è–∫—â–æ GPT –Ø–í–ù–û –ø—Ä–æ–ø–æ–Ω—É—î –∑—Ä–æ–±–∏—Ç–∏ —Ä–æ–∑–∫–ª–∞–¥.
    –Ø–∫—â–æ –Ω—ñ ‚Äî None.
    """
    t = _norm(reply)

    # –ß–∏ –≤–∑–∞–≥–∞–ª—ñ –π–¥–µ—Ç—å—Å—è –ø—Ä–æ –∫–∞—Ä—Ç–∏ / —Ä–æ–∑–∫–ª–∞–¥
    if not any(k in t for k in ["–∫–∞—Ä—Ç", "–∫–∞—Ä—Ç–∞", "–∫–∞—Ä—Ç–∏", "—Ä–æ–∑–∫–ª–∞–¥", "–ø–æ–∑–∏—Ü—ñ"]):
        return None

    # –ß–∏ —î –¥—ñ—è: —Ç—è–≥–Ω—É—Ç–∏ / —Ä–æ–±–∏—Ç–∏ —Ä–æ–∑–∫–ª–∞–¥ / –≤–∑—è—Ç–∏ –∫–∞—Ä—Ç–∏
    verb_trigger = re.search(
        r"(—Ä–æ–∑–∫–ª–∞–¥|–≤–∏—Ç—è–≥–Ω|–≤–∏—Ç—è–≥–Ω—É|–≤–∏—Ç—è–≥–Ω–µ–º–æ|—Ç—è–≥–Ω—É—Ç|—Ç—è–≥–Ω—É|—Ç—è–≥–Ω–µ–º–æ|–≤—ñ–∑—å–º|–≤–∑—è—Ç–∏|–≤–∑—è–≤|–≥–ª—è–Ω—É|–ø–æ–¥–∏–≤–ª—é—Å—å|–ø–æ–¥–∏–≤–ª—é—Å—è|–ø–æ–¥–∏–≤–∏–º–æ—Å—å|–ø–æ–¥–∏–≤–∏–º–æ—Å—è|–∑—Ä–æ–±–∏–º–æ —Ä–æ–∑–∫–ª–∞–¥|–∑—Ä–æ–±–∏—Ç–∏ —Ä–æ–∑–∫–ª–∞–¥|–ø—Ä–æ–ø–æ–Ω—É—é.*—Ä–æ–∑–∫–ª–∞–¥|–∑–∞–ø—Ä–æ–ø–æ–Ω—É–≤–∞–≤.*—Ä–æ–∑–∫–ª–∞–¥|–≥–æ—Ç–æ–≤–∏–π.*–∫–∞—Ä—Ç)",
        t,
    )
    # –æ–∫—Ä–µ–º–æ –¥–æ–∑–≤–æ–ª—è—î–º–æ ¬´–∫–∞—Ä—Ç–∞ –¥–Ω—è¬ª –Ω–∞–≤—ñ—Ç—å –±–µ–∑ –¥—ñ—î—Å–ª–æ–≤–∞
    if not verb_trigger and "–∫–∞—Ä—Ç–∞ –¥–Ω—è" not in t:
        return None

    # –°–ø–µ—Ü—ñ–∞–ª—å–Ω—ñ –≤–∏–ø–∞–¥–∫–∏
    if "–∫–µ–ª—å—Ç—Å—å–∫" in t or "–∫–µ–ª—å—Ç—Å—å–∫–∏–π —Ö—Ä–µ—Å—Ç" in t:
        return 10

    # –Ø–≤–Ω—ñ –∫—ñ–ª—å–∫–æ—Å—Ç—ñ (10 / 5 / 4 / 3 / 1)
    patterns = [
        (10, r"(10|–¥–µ—Å—è—Ç—å)\s*(–∫–∞—Ä—Ç|–ø–æ–∑–∏—Ü—ñ)"),
        (5, r"(5|–ø'—è—Ç—å|–ø—è—Ç—å)\s*(–∫–∞—Ä—Ç|–ø–æ–∑–∏—Ü—ñ)"),
        (4, r"(4|—á–æ—Ç–∏—Ä–∏|—á–æ—Ç–∏—Ä—å–æ—Ö)\s*(–∫–∞—Ä—Ç|–ø–æ–∑–∏—Ü—ñ)"),
        (3, r"(3|—Ç—Ä–∏)\s*(–∫–∞—Ä—Ç|–ø–æ–∑–∏—Ü—ñ)"),
        (1, r"(1|–æ–¥–Ω—É|–æ–¥–Ω–∞|—î–¥–∏–Ω—É|—î–¥–∏–Ω–∞)\s*–∫–∞—Ä—Ç"),
    ]
    for amount, pat in patterns:
        if re.search(pat, t):
            return amount

    # ¬´–∫–∞—Ä—Ç–∞ –¥–Ω—è¬ª
    if "–∫–∞—Ä—Ç–∞ –¥–Ω—è" in t:
        return 1

    # –º–∏–Ω—É–ª–µ- —Ç–µ–ø–µ—Ä—ñ—à–Ω—î - –º–∞–π–±—É—Ç–Ω—î ‚Üí 3
    if "–º–∏–Ω—É–ª–µ" in t and "—Ç–µ–ø–µ—Ä—ñ—à–Ω" in t:
        return 3

    # –ª—é–±–æ–≤–Ω—ñ —Ç–µ–º–∏ ‚Üí 4 –∞–±–æ 5
    if any(w in t for w in ["—Å—Ç–æ—Å—É–Ω–∫", "–∫–æ—Ö–∞–Ω", "–≤—ñ–¥–Ω–æ—Å–∏–Ω"]):
        if "—á–æ—Ç–∏—Ä–∏" in t or "4" in t:
            return 4
        # —è–∫—â–æ —Ö–æ—á–µ –≥–ª–∏–±—à–µ / —Å–µ—Ä–π–æ–∑–Ω—ñ—à–µ
        if "–≥–ª–∏–±—à" in t or "–≥–ª–∏–±–æ–∫" in t:
            return 5

    # ¬´–≤–µ–ª–∏–∫–∏–π —Ä–æ–∑–∫–ª–∞–¥¬ª, ¬´–≥–ª–∏–±–æ–∫–∏–π —Ä–æ–∑–∫–ª–∞–¥¬ª ‚Üí 10
    if "–≤–µ–ª–∏–∫–∏–π —Ä–æ–∑–∫–ª–∞–¥" in t or "–≥–ª–∏–±–æ–∫–∏–π —Ä–æ–∑–∫–ª–∞–¥" in t:
        return 10

    # —è–∫—â–æ –ø—Ä–æ—Å—Ç–æ —Å–ª–æ–≤–æ ¬´—Ä–æ–∑–∫–ª–∞–¥¬ª –±–µ–∑ —Ü–∏—Ñ—Ä–∏ ‚Üí –±–∞–∑–æ–≤–æ 3 –∫–∞—Ä—Ç–∏
    if "—Ä–æ–∑–∫–ª–∞–¥" in t:
        return 3

    # –∑–∞–ø–∞—Å–Ω–∏–π –≤–∞—Ä—ñ–∞–Ω—Ç: —î –¥—ñ—î—Å–ª–æ–≤–æ —ñ —Å–ª–æ–≤–æ ¬´–∫–∞—Ä—Ç¬ª ‚Üí 1 –∫–∞—Ä—Ç–∞
    if re.search(r"–∫–∞—Ä—Ç[–∞–µ–∏–æ—É—ñ]", t):
        return 1

    return None


# ================== START DIALOG ===================


@dialog_router.message(F.text == "üîÆ –ñ–∏–≤–∏–π –¢–∞—Ä–æ-—á–∞—Ç")
async def start_dialog(message: types.Message, state: FSMContext):
    await state.set_state(TarotChatFSM.chatting)
    user_histories[message.from_user.id] = []  # reset

    # —Å–∏—Å—Ç–µ–º–Ω–∏–π –ø—Ä–æ–º–ø—Ç –∑ –±–∞–∑–æ—é –∑–Ω–∞–Ω—å
    add_message(message.from_user.id, "system", SYSTEM_PROMPT)

    welcome = (
        "‚ú® –Ø —Ç—É—Ç. –î–∞–≤–∞–π –ø–æ–≥–æ–≤–æ—Ä–∏–º–æ —Ç–∞–∫, –Ω—ñ–±–∏ —Ç–∏ –ø–æ—Ä—É—á.\n"
        "–ú–æ–∂–µ—à –∑–∞–ø–∏—Ç–∞—Ç–∏ –ø—Ä–æ –¥–µ–Ω—å, —Å—Ç–æ—Å—É–Ω–∫–∏, —Ä–æ–±–æ—Ç—É, –≤–∏–±—ñ—Ä –∞–±–æ –±—É–¥—å-—è–∫—É —Å–∏—Ç—É–∞—Ü—ñ—é, —è–∫–∞ —Ö–≤–∏–ª—é—î."
    )

    add_message(message.from_user.id, "assistant", welcome)
    await message.answer(welcome, reply_markup=dialog_kb())


# ================== EXIT ===================


@dialog_router.message(F.text == EXIT_TEXT)
async def exit_dialog(message: types.Message, state: FSMContext):
    await state.clear()
    await message.answer("üîö –Ø –ø–æ—Ä—É—á, –∫–æ–ª–∏ –∑–∞—Ö–æ—á–µ—à –ø—Ä–æ–¥–æ–≤–∂–∏—Ç–∏.", reply_markup=menu)


# ================== MAIN CHAT ===================


@dialog_router.message(TarotChatFSM.chatting)
async def chat(message: types.Message, state: FSMContext):
    user_id = message.from_user.id
    text = message.text

    # 1) –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞ ‚Üí –≤ —ñ—Å—Ç–æ—Ä—ñ—é
    add_message(user_id, "user", text)

    # 2) –ø–µ—Ä–≤–∏–Ω–Ω–∞ –≤—ñ–¥–ø–æ–≤—ñ–¥—å GPT (–¥—ñ–∞–ª–æ–≥ + –ø—Ä–æ–ø–æ–∑–∏—Ü—ñ—è —Ä–æ–∑–∫–ª–∞–¥—É)
    response = await client.chat.completions.create(
        model="gpt-4.1-mini",
        messages=get_history(user_id),
        max_tokens=4000,
    )

    reply = response.choices[0].message.content

    # 3) –∑–±–µ—Ä—ñ–≥–∞—î–º–æ –π –ø–æ–∫–∞–∑—É—î–º–æ –≤—ñ–¥–ø–æ–≤—ñ–¥—å
    add_message(user_id, "assistant", reply)
    await message.answer(reply)

    # 4) –¥–∏–≤–∏–º–æ—Å—å, —á–∏ GPT —Å–ø—Ä–∞–≤–¥—ñ —Ö–æ—á–µ –†–û–ó–ö–õ–ê–î
    amount = detect_card_request(reply)
    if amount is None or amount <= 0:
        return  # –ø—Ä–æ—Å—Ç–æ —Ä–æ–∑–º–æ–≤–∞ –±–µ–∑ –∫–∞—Ä—Ç

    # 5) —Ç—è–≥–Ω–µ–º–æ –∫–∞—Ä—Ç–∏
    cards = draw_cards(amount)

    # –ª–µ–≥–∫–∞ "–∞–Ω—ñ–º–∞—Ü—ñ—è", —â–æ–± –≤—ñ–¥—á—É–≤–∞–ª–æ—Å—è —è–∫ –ø—Ä–æ—Ü–µ—Å
    await asyncio.sleep(0.3)

    # 6) –ø–æ–∫–∞–∑—É—î–º–æ –∫–∞—Ä—Ç–∏ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—É
    if len(cards) == 1:
        c = cards[0]
        buf = load_img(c["image"], c["upright"])
        file = types.BufferedInputFile(buf.getvalue(), filename=f"{c['code']}.jpg")
        arrow = "‚¨ÜÔ∏è" if c["upright"] else "‚¨áÔ∏è"
        caption = f"{c['ua']} {arrow}"
        await message.answer_photo(photo=file, caption=caption)
    else:
        media = []
        for idx, c in enumerate(cards):
            buf = load_img(c["image"], c["upright"])
            file = types.BufferedInputFile(
                buf.getvalue(), filename=f"{c['code']}_{idx}.jpg"
            )
            arrow = "‚¨ÜÔ∏è" if c["upright"] else "‚¨áÔ∏è"
            caption = f"{c['ua']} {arrow}" if idx == 0 else None
            media.append(types.InputMediaPhoto(media=file, caption=caption))

        await message.answer_media_group(media)

    # 7) —Ç–µ–∫—Å—Ç–æ–≤–∏–π –æ–ø–∏—Å –≤–∏—Ç—è–≥–Ω—É—Ç–∏—Ö –∫–∞—Ä—Ç ‚Üí GPT
    cards_text = "–í–∏—Ç—è–≥–Ω—É—Ç—ñ –∫–∞—Ä—Ç–∏:\n" + "\n".join(
        f"{c['ua']} ({c['code']}) ‚Äî {'–ø—Ä—è–º–∞' if c['upright'] else '–ø–µ—Ä–µ–≤–µ—Ä–Ω—É—Ç–∞'}"
        for c in cards
    )

    add_message(user_id, "user", cards_text)

    # 8) –¥—Ä—É–≥–∏–π –≤–∏–∫–ª–∏–∫ GPT ‚Äî —Ç–ª—É–º–∞—á–µ–Ω–Ω—è —Ä–æ–∑–∫–ª–∞–¥—É
    follow = await client.chat.completions.create(
        model="gpt-4.1-mini",
        messages=get_history(user_id),
        max_tokens=5000,
    )

    final_reply = follow.choices[0].message.content
    add_message(user_id, "assistant", final_reply)

    await message.answer(final_reply)
